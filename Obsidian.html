<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Obsidian Clone</title>
  <style>
    :root {
      --bg-color: #1e1e1e;
      --sidebar-bg: #252526;
      --text-color: #dcddde;
      --accent-color: #7b68ee;
      --border-color: #333;
      --hover-color: #2a2d2e;
      --active-file-bg: #37373d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: Consolas, "Courier New", monospace;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: 250px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 10px;
      user-select: none;
    }

    #sidebar h2 {
      font-size: 1.2rem;
      margin-bottom: 20px;
      color: var(--accent-color);
      padding-left: 10px;
    }

    #file-list {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
    }

    .file-item {
      padding: 8px 10px;
      cursor: pointer;
      border-radius: 4px;
      color: #ccc;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
    }

    .file-item:hover {
      background-color: var(--hover-color);
    }

    .file-item.active {
      background-color: var(--active-file-bg);
      color: #fff;
      border-left: 3px solid var(--accent-color);
    }

    .file-icon {
      margin-right: 8px;
      font-size: 1.1em;
    }

    /* Main Area */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    header {
      padding: 10px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #current-file-name {
      font-size: 1.1rem;
      font-weight: bold;
    }

    /* Editor */
    #editor-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    textarea#editor {
      flex: 1;
      background-color: var(--bg-color);
      color: var(--text-color);
      border: none;
      padding: 20px;
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.6;
      resize: none;
      outline: none;
      white-space: pre-wrap;
      border-right: 1px solid var(--border-color);
    }

    #preview {
      display: block;
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: var(--bg-color);
    }

    /* Markdown Styles */
    #preview h1 {
      color: var(--accent-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 5px;
      margin-top: 0;
    }

    #preview h2 {
      color: #ccb;
      margin-top: 1.5em;
    }

    #preview h3 {
      color: #ccb;
      margin-top: 1.2em;
      font-size: 1.1em;
    }

    #preview ul {
      padding-left: 20px;
    }

    #preview li {
      margin-bottom: 4px;
    }

    #preview b {
      color: #fff;
    }

    #preview a.internal-link {
      color: var(--accent-color);
      text-decoration: none;
      border-bottom: 1px dashed var(--accent-color);
      cursor: pointer;
    }

    #preview a.internal-link:hover {
      background-color: rgba(123, 104, 238, 0.1);
    }

    /* Graph Modal */
    #graph-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #graph-container {
      position: relative;
      width: 80%;
      height: 80%;
      background-color: #111;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    #close-graph-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #333;
      color: #fff;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      z-index: 10;
      border-radius: 4px;
    }
  </style>
</head>

<body>

  <div id="sidebar">
    <h2>Obsidian</h2>
    <ul id="file-list">
      <!-- File list items will be injected here -->
    </ul>
    <div style="margin-top: auto;">
      <button id="graph-view-btn"
        style="width: 100%; padding: 8px; background: #333; color: white; border: none; cursor: pointer; border-radius: 4px; margin-bottom: 5px;">üï∏Ô∏è
        Graph View</button>
      <button id="new-file-btn"
        style="width: 100%; padding: 8px; background: var(--accent-color); color: white; border: none; cursor: pointer; border-radius: 4px;">+
        New File</button>
    </div>
  </div>

  <div id="main">
    <header>
      <span id="current-file-name">Home.md</span>
      <div>
        <button id="save-btn"
          style="background:none; border: 1px solid #555; color: #ccc; padding: 4px 10px; cursor: pointer; border-radius: 3px;">Save</button>
      </div>
    </header>
    <div id="editor-container">
      <textarea id="editor" placeholder="Start typing..."></textarea>
      <div id="preview"></div>
    </div>
  </div>

  <!-- Graph Modal -->
  <div id="graph-modal">
    <div id="graph-container">
      <button id="close-graph-btn">Close</button>
      <canvas id="graph-canvas"></canvas>
    </div>
  </div>

  <script>
    // --- Data Structure (Virtual Vault) ---
    const vault = {
      files: {
        "Home.md": "# Welcome\nThis is my **[[Knowledge Base]]**.\n\n- Idea 1\n- Idea 2\n\nStart typing to create your network of thoughts.",
        "Knowledge Base.md": "# Knowledge Base\nThis is a linked note.\n\nLink back to [[Home]].\nAlso see [[Ideas]]",
        "Ideas.md": "# Ideas\n- [[Project A]]\n- [[Project B]]"
      },
      activeFile: "Home.md",
      theme: "dark"
    };

    // --- State Management ---
    const state = {
      activeFile: null
    };

    // --- DOM Elements ---
    const fileListEl = document.getElementById('file-list');
    const editorEl = document.getElementById('editor');
    const previewEl = document.getElementById('preview');
    const currentFileNameEl = document.getElementById('current-file-name');
    const newFileBtn = document.getElementById('new-file-btn');
    const saveBtn = document.getElementById('save-btn');
    const graphViewBtn = document.getElementById('graph-view-btn');
    const graphModal = document.getElementById('graph-modal');
    const closeGraphBtn = document.getElementById('close-graph-btn');
    const canvas = document.getElementById('graph-canvas');
    const ctx = canvas.getContext('2d');

    // --- Functions ---

    function init() {
      renderSidebar();
      openFile(vault.activeFile);

      // Auto-save & Preview Update
      editorEl.addEventListener('input', (e) => {
        if (state.activeFile) {
          const content = e.target.value;
          vault.files[state.activeFile] = content;
          updatePreview(content);
        }
      });

      newFileBtn.addEventListener('click', () => {
        const fileName = prompt("Enter file name (e.g. Note.md):", "Untitled.md");
        if (fileName) {
          if (!vault.files[fileName]) {
            vault.files[fileName] = "# " + fileName.replace('.md', '');
            renderSidebar();
            openFile(fileName);
          } else {
            openFile(fileName);
          }
        }
      });

      saveBtn.addEventListener('click', () => {
        alert('Saved to Virtual Vault!');
      });

      graphViewBtn.addEventListener('click', openGraphView);
      closeGraphBtn.addEventListener('click', () => {
        graphModal.style.display = 'none';
      });
    }

    function renderSidebar() {
      fileListEl.innerHTML = '';
      Object.keys(vault.files).forEach(fileName => {
        const li = document.createElement('li');
        li.className = 'file-item';
        if (fileName === state.activeFile) {
          li.classList.add('active');
        }
        li.innerHTML = `<span class="file-icon">üìÑ</span> ${fileName}`;
        li.onclick = () => openFile(fileName);
        fileListEl.appendChild(li);
      });
    }

    function openFile(fileName) {
      if (!vault.files.hasOwnProperty(fileName)) {
        vault.files[fileName] = "# " + fileName.replace('.md', '');
        renderSidebar();
      }

      state.activeFile = fileName;
      currentFileNameEl.textContent = fileName;
      const content = vault.files[fileName];
      editorEl.value = content;
      updatePreview(content);

      renderSidebar();
    }

    function updatePreview(markdown) {
      previewEl.innerHTML = parseMarkdown(markdown);
    }

    function parseMarkdown(text) {
      if (!text) return '';
      let html = text
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/gim, '<b>$1</b>')
        .replace(/^- (.*$)/gim, '<li style="list-style-position: inside;">$1</li>')
        .replace(/\[\[(.*?)\]\]/g, (match, p1) => {
          const fileName = p1.trim() + ".md";
          return `<a href="#" class="internal-link" onclick="openFile('${fileName}'); return false;">${p1}</a>`;
        })
        .replace(/\n/gim, '<br>');

      return html;
    }

    // --- Graph View Logic ---

    function openGraphView() {
      graphModal.style.display = 'flex';
      // Resize canvas
      const container = document.getElementById('graph-container');
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight;

      renderGraph();
    }

    function renderGraph() {
      // 1. Build Nodes and Edges
      const files = Object.keys(vault.files);
      const nodes = [];
      const edges = [];

      // Create nodes
      files.forEach((file, index) => {
        nodes.push({
          id: file,
          x: Math.random() * canvas.width * 0.8 + canvas.width * 0.1,
          y: Math.random() * canvas.height * 0.8 + canvas.height * 0.1,
          radius: 5,
          color: "#7b68ee"
        });
      });

      // Create edges
      files.forEach(file => {
        const content = vault.files[file];
        const regex = /\[\[(.*?)\]\]/g;
        let match;
        while ((match = regex.exec(content)) !== null) {
          const targetName = match[1].trim() + ".md";
          // Only if target exists (or strictly, we track all mentioned)
          // For simplicity, only draw if target is in our file list (which it might not be if created via link but not clicked yet?
          // Wait, openFile creates it. But typing [[New]] doesn't create file until clicked.
          // So we should check if target exists in nodes.
          if (vault.files[targetName]) {
            edges.push({ source: file, target: targetName });
          }
        }
      });

      // 2. Draw
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw Edges
      ctx.strokeStyle = "#555";
      ctx.lineWidth = 1;
      edges.forEach(edge => {
        const sourceNode = nodes.find(n => n.id === edge.source);
        const targetNode = nodes.find(n => n.id === edge.target);
        if (sourceNode && targetNode) {
          ctx.beginPath();
          ctx.moveTo(sourceNode.x, sourceNode.y);
          ctx.lineTo(targetNode.x, targetNode.y);
          ctx.stroke();
        }
      });

      // Draw Nodes
      nodes.forEach(node => {
        // Circle
        ctx.beginPath();
        ctx.arc(node.x, node.y, node.radius, 0, Math.PI * 2);
        ctx.fillStyle = node.color;
        ctx.fill();

        // Text
        ctx.fillStyle = "#ccc";
        ctx.font = "12px monospace";
        ctx.fillText(node.id.replace('.md', ''), node.x + 10, node.y + 4);
      });
    }

    // --- Start App ---
    init();

  </script>

</body>

</html>
