<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel Diff Tool - サイドバイサイド比較</title>
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
    rel="stylesheet">
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- Material Symbols -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

  <style>
    :root {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --border-color: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --accent-blue: #3b82f6;
      --diff-added-bg: #dcfce7;
      --diff-added-border: #86efac;
      --diff-deleted-bg: #fee2e2;
      --diff-deleted-border: #fca5a5;
      --diff-modified-bg: #fef3c7;
      --diff-modified-border: #fcd34d;
      --row-highlight: #f0f9ff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      background-color: var(--bg-primary);
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--text-primary);
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0 24px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .header h1 .material-symbols-outlined {
      color: #10b981;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.15s ease;
    }

    .btn:hover {
      background: var(--bg-primary);
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Setup Area */
    #setup-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px;
      gap: 32px;
    }

    .dropzone-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      width: 100%;
      max-width: 800px;
    }

    .dropzone {
      border: 2px dashed var(--border-color);
      border-radius: 16px;
      padding: 48px 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dropzone:hover {
      border-color: var(--accent-blue);
      background: #f8faff;
    }

    .dropzone.dragover {
      border-color: var(--accent-blue);
      background: #eff6ff;
    }

    .dropzone .material-symbols-outlined {
      font-size: 48px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .dropzone-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .dropzone-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .dropzone-status {
      margin-top: 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-blue);
      display: none;
    }

    .dropzone-status.visible {
      display: block;
    }

    /* Diff Interface */
    #diff-interface {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    #diff-interface.active {
      display: flex;
    }

    /* Toolbar */
    .toolbar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sheet-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sheet-selector label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .sheet-selector select {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg-secondary);
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }

    .legend-color.deleted {
      background: var(--diff-deleted-bg);
      border: 1px solid var(--diff-deleted-border);
    }

    .legend-color.added {
      background: var(--diff-added-bg);
      border: 1px solid var(--diff-added-border);
    }

    .legend-color.modified {
      background: var(--diff-modified-bg);
      border: 1px solid var(--diff-modified-border);
    }

    .nav-buttons {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .nav-btn:hover {
      background: var(--bg-primary);
    }

    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .diff-counter {
      font-size: 13px;
      color: var(--text-secondary);
      min-width: 80px;
      text-align: center;
    }

    /* Side by Side Container */
    .diff-container {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      overflow: hidden;
    }

    .diff-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-right: 1px solid var(--border-color);
    }

    .diff-panel:last-child {
      border-right: none;
    }

    .panel-header {
      padding: 12px 16px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .panel-header.old {
      color: #dc2626;
    }

    .panel-header.new {
      color: #16a34a;
    }

    .panel-scroll {
      flex: 1;
      overflow: auto;
      background: var(--bg-secondary);
    }

    /* Excel-like Table */
    .excel-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
      table-layout: fixed;
    }

    .excel-table th,
    .excel-table td {
      border-right: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      padding: 6px 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 80px;
      max-width: 200px;
      height: 28px;
    }

    .excel-table th {
      background: #f1f5f9;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .excel-table .row-num {
      background: #f1f5f9;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: center;
      min-width: 50px;
      max-width: 50px;
      width: 50px;
      position: sticky;
      left: 0;
      z-index: 5;
    }

    .excel-table th.row-num {
      z-index: 15;
    }

    /* Diff Row Styles */
    .diff-row {
      background: var(--row-highlight);
    }

    .diff-row .row-num {
      background: #dbeafe !important;
    }

    .cell-added {
      background: var(--diff-added-bg) !important;
      border-left: 3px solid var(--diff-added-border) !important;
    }

    .cell-deleted {
      background: var(--diff-deleted-bg) !important;
      border-left: 3px solid var(--diff-deleted-border) !important;
      text-decoration: line-through;
      color: #991b1b;
    }

    .cell-modified {
      background: var(--diff-modified-bg) !important;
      border-left: 3px solid var(--diff-modified-border) !important;
    }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .empty-state .material-symbols-outlined {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dropzone-container {
        grid-template-columns: 1fr;
      }

      .diff-container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
      }

      .diff-panel {
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }

      .toolbar {
        flex-wrap: wrap;
        gap: 12px;
      }
    }
  </style>
</head>

<body>

  <!-- Header -->
  <header class="header">
    <h1>
      <span class="material-symbols-outlined">compare</span>
      Excel Diff Tool
    </h1>
    <div class="header-actions">
      <button class="btn" onclick="location.reload()">
        <span class="material-symbols-outlined" style="font-size: 18px;">refresh</span>
        リセット
      </button>
    </div>
  </header>

  <!-- Setup Area -->
  <div id="setup-area">
    <div class="dropzone-container">
      <!-- Old File -->
      <div class="dropzone" id="drop-old" onclick="document.getElementById('file-old').click()">
        <input type="file" id="file-old" hidden accept=".xlsx,.xls,.csv">
        <span class="material-symbols-outlined">draft</span>
        <div class="dropzone-title">変更前ファイル (Before)</div>
        <div class="dropzone-subtitle">クリックまたはドラッグ&ドロップ</div>
        <div class="dropzone-status" id="status-old"></div>
      </div>

      <!-- New File -->
      <div class="dropzone" id="drop-new" onclick="document.getElementById('file-new').click()">
        <input type="file" id="file-new" hidden accept=".xlsx,.xls,.csv">
        <span class="material-symbols-outlined">note_add</span>
        <div class="dropzone-title">変更後ファイル (After)</div>
        <div class="dropzone-subtitle">クリックまたはドラッグ&ドロップ</div>
        <div class="dropzone-status" id="status-new"></div>
      </div>
    </div>

    <button id="btn-compare" class="btn btn-primary" disabled>
      <span class="material-symbols-outlined" style="font-size: 18px;">difference</span>
      比較を開始
    </button>
  </div>

  <!-- Diff Interface -->
  <div id="diff-interface">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="sheet-selector">
          <label>シート:</label>
          <select id="sheet-select"></select>
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color deleted"></div>
            <span>削除</span>
          </div>
          <div class="legend-item">
            <div class="legend-color added"></div>
            <span>追加</span>
          </div>
          <div class="legend-item">
            <div class="legend-color modified"></div>
            <span>変更</span>
          </div>
        </div>
      </div>
      <div class="toolbar-right">
        <div class="nav-buttons">
          <button class="nav-btn" id="btn-prev" title="前の変更">
            <span class="material-symbols-outlined" style="font-size: 18px;">keyboard_arrow_up</span>
          </button>
          <button class="nav-btn" id="btn-next" title="次の変更">
            <span class="material-symbols-outlined" style="font-size: 18px;">keyboard_arrow_down</span>
          </button>
        </div>
        <div class="diff-counter" id="diff-counter">0 / 0 件</div>
        <button class="btn" id="btn-diff-only">
          <span class="material-symbols-outlined" style="font-size: 18px;">filter_alt</span>
          変更のみ表示
        </button>
      </div>
    </div>

    <!-- Side by Side Panels -->
    <div class="diff-container">
      <div class="diff-panel">
        <div class="panel-header old">
          <span class="material-symbols-outlined" style="font-size: 18px;">remove_circle</span>
          <span id="old-filename">変更前</span>
        </div>
        <div class="panel-scroll" id="panel-old"></div>
      </div>
      <div class="diff-panel">
        <div class="panel-header new">
          <span class="material-symbols-outlined" style="font-size: 18px;">add_circle</span>
          <span id="new-filename">変更後</span>
        </div>
        <div class="panel-scroll" id="panel-new"></div>
      </div>
    </div>
  </div>

  <script>
    // State
    let oldWorkbook = null;
    let newWorkbook = null;
    let oldFile = null;
    let newFile = null;
    let currentSheetName = null;
    let isDiffOnly = false;
    let diffRows = []; // Array of row indices with changes
    let currentDiffIndex = -1;

    // Elements
    const dropOld = document.getElementById('drop-old');
    const dropNew = document.getElementById('drop-new');
    const inputOld = document.getElementById('file-old');
    const inputNew = document.getElementById('file-new');
    const statusOld = document.getElementById('status-old');
    const statusNew = document.getElementById('status-new');
    const btnCompare = document.getElementById('btn-compare');
    const setupArea = document.getElementById('setup-area');
    const diffInterface = document.getElementById('diff-interface');
    const sheetSelect = document.getElementById('sheet-select');
    const panelOld = document.getElementById('panel-old');
    const panelNew = document.getElementById('panel-new');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const btnDiffOnly = document.getElementById('btn-diff-only');
    const diffCounter = document.getElementById('diff-counter');

    // Drag & Drop Setup
    function setupDragDrop(dropZone, input, statusElem, isOld) {
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          handleFile(e.dataTransfer.files[0], isOld, statusElem);
        }
      });
      input.addEventListener('change', (e) => {
        if (e.target.files.length) {
          handleFile(e.target.files[0], isOld, statusElem);
        }
      });
    }

    function handleFile(file, isOld, statusElem) {
      statusElem.textContent = file.name;
      statusElem.classList.add('visible');
      if (isOld) {
        oldFile = file;
        document.getElementById('old-filename').textContent = file.name;
      } else {
        newFile = file;
        document.getElementById('new-filename').textContent = file.name;
      }
      checkReady();
    }

    setupDragDrop(dropOld, inputOld, statusOld, true);
    setupDragDrop(dropNew, inputNew, statusNew, false);

    function checkReady() {
      btnCompare.disabled = !(oldFile && newFile);
    }

    // Read Excel File
    function readExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          resolve(workbook);
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    // Start Comparison
    btnCompare.addEventListener('click', async () => {
      try {
        btnCompare.disabled = true;
        btnCompare.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">hourglass_empty</span> 読み込み中...';

        oldWorkbook = await readExcel(oldFile);
        newWorkbook = await readExcel(newFile);

        // Setup sheet selector
        const sheets = [...new Set([...oldWorkbook.SheetNames, ...newWorkbook.SheetNames])];
        sheetSelect.innerHTML = sheets.map(name => `<option value="${name}">${name}</option>`).join('');

        // Switch view
        setupArea.style.display = 'none';
        diffInterface.classList.add('active');

        // Initial render
        currentSheetName = sheets[0];
        renderDiff(currentSheetName);

        // Sheet change listener
        sheetSelect.addEventListener('change', (e) => {
          currentSheetName = e.target.value;
          renderDiff(currentSheetName);
        });

      } catch (error) {
        alert('エラーが発生しました: ' + error.message);
        console.error(error);
        btnCompare.disabled = false;
        btnCompare.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">difference</span> 比較を開始';
      }
    });

    // Sync Scroll
    let isSyncing = false;
    function setupSyncScroll() {
      [panelOld, panelNew].forEach((panel, idx) => {
        panel.addEventListener('scroll', () => {
          if (isSyncing) return;
          isSyncing = true;
          const other = idx === 0 ? panelNew : panelOld;
          other.scrollTop = panel.scrollTop;
          other.scrollLeft = panel.scrollLeft;
          requestAnimationFrame(() => { isSyncing = false; });
        });
      });
    }
    setupSyncScroll();

    // Navigation
    btnPrev.addEventListener('click', () => navigateDiff(-1));
    btnNext.addEventListener('click', () => navigateDiff(1));

    function navigateDiff(direction) {
      if (diffRows.length === 0) return;

      currentDiffIndex += direction;
      if (currentDiffIndex < 0) currentDiffIndex = diffRows.length - 1;
      if (currentDiffIndex >= diffRows.length) currentDiffIndex = 0;

      updateDiffCounter();
      scrollToRow(diffRows[currentDiffIndex]);
    }

    function scrollToRow(rowIndex) {
      const rowOld = panelOld.querySelector(`tr[data-row="${rowIndex}"]`);
      const rowNew = panelNew.querySelector(`tr[data-row="${rowIndex}"]`);

      if (rowOld) {
        rowOld.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function updateDiffCounter() {
      if (diffRows.length === 0) {
        diffCounter.textContent = '変更なし';
      } else {
        diffCounter.textContent = `${currentDiffIndex + 1} / ${diffRows.length} 件`;
      }
    }

    // Toggle Diff Only
    btnDiffOnly.addEventListener('click', () => {
      isDiffOnly = !isDiffOnly;
      btnDiffOnly.innerHTML = isDiffOnly
        ? '<span class="material-symbols-outlined" style="font-size: 18px;">filter_alt_off</span> すべて表示'
        : '<span class="material-symbols-outlined" style="font-size: 18px;">filter_alt</span> 変更のみ表示';
      renderDiff(currentSheetName);
    });

    // Core Diff Rendering
    function renderDiff(sheetName) {
      const oldSheet = oldWorkbook.Sheets[sheetName] || {};
      const newSheet = newWorkbook.Sheets[sheetName] || {};

      const oldData = XLSX.utils.sheet_to_json(oldSheet, { header: 1, defval: null });
      const newData = XLSX.utils.sheet_to_json(newSheet, { header: 1, defval: null });

      const maxRows = Math.max(oldData.length, newData.length);
      let maxCols = 0;
      oldData.forEach(r => maxCols = Math.max(maxCols, r ? r.length : 0));
      newData.forEach(r => maxCols = Math.max(maxCols, r ? r.length : 0));

      // Reset diff tracking
      diffRows = [];
      currentDiffIndex = -1;

      // Build diff map
      const diffMap = [];
      for (let r = 0; r < maxRows; r++) {
        const rowOld = oldData[r] || [];
        const rowNew = newData[r] || [];
        const rowDiff = [];
        let rowHasChanges = false;

        for (let c = 0; c < maxCols; c++) {
          const valOld = rowOld[c];
          const valNew = rowNew[c];
          const strOld = (valOld === undefined || valOld === null) ? '' : String(valOld);
          const strNew = (valNew === undefined || valNew === null) ? '' : String(valNew);

          if (strOld !== strNew) {
            rowHasChanges = true;
            if (strOld === '' && strNew !== '') {
              rowDiff.push({ type: 'added', old: strOld, new: strNew });
            } else if (strOld !== '' && strNew === '') {
              rowDiff.push({ type: 'deleted', old: strOld, new: strNew });
            } else {
              rowDiff.push({ type: 'modified', old: strOld, new: strNew });
            }
          } else {
            rowDiff.push({ type: 'unchanged', old: strOld, new: strNew });
          }
        }

        if (rowHasChanges) {
          diffRows.push(r);
        }
        diffMap.push({ rowDiff, hasChanges: rowHasChanges });
      }

      // Create tables
      panelOld.innerHTML = createTable(diffMap, maxCols, 'old');
      panelNew.innerHTML = createTable(diffMap, maxCols, 'new');

      // Update counter
      if (diffRows.length > 0) {
        currentDiffIndex = 0;
      }
      updateDiffCounter();
      updateNavButtons();
    }

    function createTable(diffMap, maxCols, side) {
      const rows = [];

      // Header
      let headerCells = '<th class="row-num"></th>';
      for (let c = 0; c < maxCols; c++) {
        headerCells += `<th>${XLSX.utils.encode_col(c)}</th>`;
      }
      rows.push(`<tr>${headerCells}</tr>`);

      // Data rows
      for (let r = 0; r < diffMap.length; r++) {
        const { rowDiff, hasChanges } = diffMap[r];

        // Skip unchanged rows in diff-only mode
        if (isDiffOnly && !hasChanges) continue;

        const rowClass = hasChanges ? 'diff-row' : '';
        let cells = `<td class="row-num">${r + 1}</td>`;

        for (let c = 0; c < maxCols; c++) {
          const cell = rowDiff[c] || { type: 'unchanged', old: '', new: '' };
          const value = side === 'old' ? cell.old : cell.new;
          let cellClass = '';

          if (cell.type === 'added') {
            cellClass = side === 'new' ? 'cell-added' : '';
          } else if (cell.type === 'deleted') {
            cellClass = side === 'old' ? 'cell-deleted' : '';
          } else if (cell.type === 'modified') {
            cellClass = 'cell-modified';
          }

          cells += `<td class="${cellClass}" title="${escapeHtml(value)}">${escapeHtml(value)}</td>`;
        }

        rows.push(`<tr class="${rowClass}" data-row="${r}">${cells}</tr>`);
      }

      if (rows.length === 1) {
        // Only header, no data
        return `<div class="empty-state">
          <span class="material-symbols-outlined">check_circle</span>
          <div>${isDiffOnly ? '変更点はありません' : 'データがありません'}</div>
        </div>`;
      }

      return `<table class="excel-table"><thead>${rows[0]}</thead><tbody>${rows.slice(1).join('')}</tbody></table>`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateNavButtons() {
      btnPrev.disabled = diffRows.length === 0;
      btnNext.disabled = diffRows.length === 0;
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (!diffInterface.classList.contains('active')) return;

      if (e.key === 'ArrowUp' && e.ctrlKey) {
        e.preventDefault();
        navigateDiff(-1);
      } else if (e.key === 'ArrowDown' && e.ctrlKey) {
        e.preventDefault();
        navigateDiff(1);
      }
    });
  </script>
</body>

</html>
